import { canvas, ctx, state } from './state.js';
import { findNearestStar, ensureStarNear } from './world.js';

export function playIntro() {
  return new Promise(resolve => {
    let frame = 0;
    function anim() {
      frame++;
      ctx.fillStyle = 'black';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      ctx.save();
      ctx.translate(canvas.width / 2, canvas.height / 2);
      for (let i = 0; i < 20; i++) {
        const angle = frame * 0.1 + i * 0.4;
        const r = 30 + i * 4;
        ctx.strokeStyle = `hsla(260,100%,70%,${0.6 - i * 0.03})`;
        ctx.beginPath();
        ctx.arc(Math.cos(angle) * r, Math.sin(angle) * r, 10, 0, Math.PI * 2);
        ctx.stroke();
      }
      ctx.restore();

      const t = Math.min(1, frame / 120);
      const shipX = canvas.width * (1 - t) + canvas.width / 2 * t;
      const shipY = canvas.height / 2;
      ctx.fillStyle = 'white';
      ctx.beginPath();
      ctx.moveTo(shipX, shipY - 10);
      ctx.lineTo(shipX - 10, shipY + 10);
      ctx.lineTo(shipX + 10, shipY + 10);
      ctx.closePath();
      ctx.fill();

      if (frame < 120) {
        requestAnimationFrame(anim);
      } else {
        ensureStarNear(0, 0);

        const star = findNearestStar(0, 0);
        if (star) {
          state.playerX = star.x + star.size + 300;
          state.playerY = star.y;
        } else {
          state.playerX = 0;
          state.playerY = 0;
        }
        resolve();
      }
    }
    anim();
  });
}
